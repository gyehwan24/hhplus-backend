# Apache Kafka ë„ì… ì œì•ˆì„œ

> ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì˜ í™•ì¥ê³¼ ë©”ì‹œì§€ ì•ˆì •ì„± í™•ë³´ë¥¼ ìœ„í•œ ê¸°ìˆ  ê²€í† 

---

## 1. ë„ì… ë°°ê²½: ìš°ë¦¬ê°€ ê²ªê³  ìˆëŠ” ë¬¸ì œ

### í˜„ì¬ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì‹

```java
@Service
public class OrderPaymentService {
    
    @Transactional
    public void processPayment() {
        deductUserPoints();
        savePaymentInfo();
        updateOrderStatus();
        
        eventPublisher.publishEvent(new PaymentCompletedEvent(order));  // ApplicationEvent ë°œí–‰
    }
}

@Component
public class OrderPaymentEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void sendOrderInfo(PaymentCompletedEvent event) {
        dataCollectorApi.send(event);  // ì™¸ë¶€ API í˜¸ì¶œ
    }
}
```

Spring ApplicationEventë¥¼ í™œìš©í•œ í˜„ì¬ êµ¬ì¡°ëŠ” ì„œë¹„ìŠ¤ ì½”ë“œë¥¼ ê¹”ë”í•˜ê²Œ ìœ ì§€í•˜ê³  ê´€ì‹¬ì‚¬ë¥¼ ë¶„ë¦¬í•˜ëŠ” ë° íš¨ê³¼ì ì…ë‹ˆë‹¤.

### ë¬¸ì œì 

í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤.

| ë¬¸ì œ | ì„¤ëª… |
|------|------|
| **ë©”ì‹œì§€ ìœ ì‹¤** | Spring EventëŠ” ë©”ëª¨ë¦¬ ê¸°ë°˜. ì™¸ë¶€ API ì‹¤íŒ¨ ì‹œ ì´ë²¤íŠ¸ ì‚¬ë¼ì§ |
| **ì¬ì‹œë„ ì±…ì„** | ë°ì´í„° ìˆ˜ì§‘ í”Œë«í¼ ì¥ì•  ì‹œ ì¬ì „ì†¡ ë¡œì§ì„ ìš°ë¦¬ê°€ êµ¬í˜„í•´ì•¼ í•¨ |
| **ê°•í•œ ê²°í•©** | Producerê°€ Consumer ìƒíƒœë¥¼ ì‹ ê²½ ì¨ì•¼ í•¨ |

```
[ê¸°ì¡´ ì´ë²¤íŠ¸ ë°©ì‹ - ë©”ì‹œì§€ ìœ ì‹¤ ì‹œë‚˜ë¦¬ì˜¤]

ì£¼ë¬¸_ê²°ì œ() 
    â†“
ê²°ì œ_ì™„ë£Œ_ì´ë²¤íŠ¸_ë°œí–‰()  â† ë©”ëª¨ë¦¬ì—ë§Œ ì¡´ì¬
    â†“
@Async ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
    â†“
ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ ğŸ’¥
    â†“
ë. ë©”ì‹œì§€ ì‚¬ë¼ì§. ì¬ì‹œë„í•˜ë ¤ë©´ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•¨.
```

---

## 2. Kafkaê°€ í•´ê²°í•˜ëŠ” ê²ƒ

### Kafka ë°©ì‹ì˜ ë©”ì‹œì§€ íë¦„

```java
@Component
public class OrderPaymentEventListener {
    
    private final KafkaTemplate<String, PaymentCompletedEvent> kafkaTemplate;
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handle(PaymentCompletedEvent event) {
        kafkaTemplate.send("payment-completed", event);  // Kafkaì— ë°œí–‰
    }
}
```

```
[Kafka ë°©ì‹]

ì£¼ë¬¸_ê²°ì œ()
    â†“
kafkaProducer.publish()  â† ë¸Œë¡œì»¤ ë””ìŠ¤í¬ì— ì €ì¥
    â†“
Producer ì±…ì„ ë âœ“
    â†“
Consumer(ë°ì´í„° ìˆ˜ì§‘ í”Œë«í¼) ì¥ì•  ğŸ’¥
    â†“
ë©”ì‹œì§€ëŠ” Kafkaì— ê·¸ëŒ€ë¡œ ìˆìŒ
    â†“
ì¥ì•  ë³µêµ¬ í›„ ë§ˆì§€ë§‰ offsetë¶€í„° ë‹¤ì‹œ consume
```

### í•µì‹¬ ì°¨ì´: ë©”ì‹œì§€ ì €ì¥ì†Œì˜ ìœ ë¬´

| êµ¬ë¶„ | ê¸°ì¡´ ì´ë²¤íŠ¸ | Kafka |
|------|-----------|-------|
| ë©”ì‹œì§€ ì €ì¥ | ë©”ëª¨ë¦¬ (íœ˜ë°œì„±) | ë””ìŠ¤í¬ (ì˜ì†ì„±) |
| Consumer ì¥ì•  ì‹œ | Producerê°€ ì¬ì‹œë„ ì±…ì„ | Kafkaê°€ ë³´ê´€, Consumerê°€ ì•Œì•„ì„œ |
| ì¬ì‹œë„ êµ¬í˜„ | ì§ì ‘ í•´ì•¼ í•¨ | offset ê¸°ë°˜ ìë™ |
| ê²°í•©ë„ | Producerê°€ Consumer ìƒíƒœ ì‹ ê²½ ì”€ | ì™„ì „ ë¶„ë¦¬ |

---

## 3. Kafka ê¸°ì´ˆ ê°œë…

### 3.1 í•µì‹¬ êµ¬ì„± ìš”ì†Œ

| êµ¬ì„± ìš”ì†Œ | ì„¤ëª… |
|----------|------|
| **Broker** | Kafka ì„œë²„. Producerì˜ ë©”ì‹œì§€ë¥¼ ë°›ì•„ ë””ìŠ¤í¬ì— ì €ì¥í•˜ê³ , Consumer ìš”ì²­ì— ì‘ë‹µ |
| **Topic** | ë©”ì‹œì§€ì˜ ë…¼ë¦¬ì  ë¶„ë¥˜ ë‹¨ìœ„. 'ê²°ì œì™„ë£Œ', 'ì£¼ë¬¸ìƒì„±' ë“± ì´ë²¤íŠ¸ ì¢…ë¥˜ë³„ë¡œ ìƒì„± |
| **Partition** | í† í”½ì˜ ë¬¼ë¦¬ì  ë¶„í•  ë‹¨ìœ„. íŒŒí‹°ì…˜ ìˆ˜ = ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ Consumer ìˆ˜ |
| **Offset** | íŒŒí‹°ì…˜ ë‚´ ë©”ì‹œì§€ì˜ ìˆœì„œ ë²ˆí˜¸(0ë¶€í„° ì‹œì‘). íŒŒí‹°ì…˜ì—ì„œ ê´€ë¦¬í•˜ëŠ” ìœ„ì¹˜ ì¸ë±ìŠ¤ |
| **Replica** | íŒŒí‹°ì…˜ì˜ ë³µì œë³¸. Leaderê°€ ì½ê¸°/ì“°ê¸° ë‹´ë‹¹, Followerê°€ ë³µì œ ìœ ì§€ |
| **Consumer Group** | ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œ íŒŒí‹°ì…˜ì€ ë‹¨ í•˜ë‚˜ì˜ Consumerì—ê²Œë§Œ í• ë‹¹. ê·¸ë£¹ ë‹¨ìœ„ë¡œ offset ê´€ë¦¬ |

### 3.2 Producer â†’ Broker ì €ì¥ ê³¼ì •

```
Producerê°€ "ì£¼ë¬¸ì™„ë£Œ" ë©”ì‹œì§€ ì „ì†¡
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Broker (Partition 0)                â”‚
    â”‚                                      â”‚
    â”‚  1. í˜„ì¬ LEO(Log End Offset) = 153   â”‚
    â”‚  2. ìƒˆ ë©”ì‹œì§€ì— offset 153 ë¶€ì—¬      â”‚
    â”‚  3. ì„¸ê·¸ë¨¼íŠ¸ íŒŒì¼ì— append           â”‚
    â”‚  4. LEOë¥¼ 154ë¡œ ì—…ë°ì´íŠ¸             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    Producerì—ê²Œ ack ì‘ë‹µ (offset: 153)
```

**Q. "offset ì§€ì • í›„ ë””ìŠ¤í¬ì— ì €ì¥"ì´ë€?**

ë©”ì‹œì§€ê°€ ìì²´ì ìœ¼ë¡œ offsetì„ ê°€ì§€ê³  ì˜¤ëŠ” ê²Œ ì•„ë‹™ë‹ˆë‹¤. ë¸Œë¡œì»¤ê°€ íŒŒí‹°ì…˜ë³„ë¡œ LEO(Log End Offset)ë¥¼ ê´€ë¦¬í•˜ê³ , ìƒˆ ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¤ë©´ ê·¸ ê°’ì„ ë¶€ì—¬í•œ ë’¤ ì¦ê°€ì‹œí‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

### 3.3 Consumer Read ìš”ì²­ ê³¼ì •

```
Consumer (Group: order-service)
           â†“
    Fetch Request: "Partition 0, offset 152ë¶€í„° ì£¼ì„¸ìš”"
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Broker                              â”‚
    â”‚                                      â”‚
    â”‚  1. ìš”ì²­ offset(152) ìœ íš¨ì„± ê²€ì¦     â”‚
    â”‚  2. .index íŒŒì¼ë¡œ ì„¸ê·¸ë¨¼íŠ¸ ìœ„ì¹˜ íƒìƒ‰ â”‚
    â”‚  3. HW(High Watermark)ê¹Œì§€ë§Œ ì „ì†¡    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    Consumerì—ê²Œ ë©”ì‹œì§€ ë°°ì¹˜ ì‘ë‹µ
           â†“
    ì²˜ë¦¬ ì™„ë£Œ í›„ committed offset ì €ì¥
    â†’ __consumer_offsets í† í”½ì— ê¸°ë¡
```

**í•µì‹¬ í¬ì¸íŠ¸**

- Consumerê°€ "ë‚˜ 152ë²ˆë¶€í„° ì½ì„ê²Œ"ë¼ê³  ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­
- ë¸Œë¡œì»¤ê°€ "ë‹¤ìŒ ë©”ì‹œì§€"ë¥¼ ì•Œì•„ì„œ ì£¼ëŠ” ê²Œ ì•„ë‹˜
- ì´ì „ì— ì–´ë””ê¹Œì§€ ì½ì—ˆëŠ”ì§€ëŠ” Consumer(ë˜ëŠ” Consumer Group)ê°€ ê´€ë¦¬

### 3.4 LEO vs HW (High Watermark)

| êµ¬ë¶„ | LEO | HW |
|------|-----|-----|
| ì •ì˜ | ë‹¤ìŒì— ì“¸ offset ìœ„ì¹˜ | ëª¨ë“  ISRì— ë³µì œ ì™„ë£Œëœ ì§€ì  |
| ê´€ë¦¬ ì£¼ì²´ | ê° ë¸Œë¡œì»¤ê°€ ìê¸° ê²ƒë§Œ | ë¦¬ë”ê°€ ê³„ì‚°, íŒ”ë¡œì›Œì— ì „íŒŒ |
| Consumer | ì½ê¸° ë¶ˆê°€ | ì—¬ê¸°ê¹Œì§€ ì½ê¸° ê°€ëŠ¥ |

```
Partition ìƒíƒœ ì˜ˆì‹œ:

[150][151][152][153] [154]
                 â†‘     â†‘
                HW    LEO

- offset 154ëŠ” Leaderì—ë§Œ ìˆê³  ì•„ì§ Followerì— ë³µì œ ì•ˆ ë¨
- ConsumerëŠ” HW(153)ê¹Œì§€ë§Œ ì½ê¸° ê°€ëŠ¥
```

**ì™œ ë¶„ë¦¬í–ˆì„ê¹Œ?**

Leaderê°€ ë©”ì‹œì§€ ì €ì¥ ì§í›„ ì£½ìœ¼ë©´, ì•„ì§ Followerì— ë³µì œë˜ì§€ ì•Šì€ ë©”ì‹œì§€ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. HW ë•ë¶„ì— "ëª¨ë“  replicaê°€ ê°€ì§„ ë°ì´í„°ë§Œ Consumerì—ê²Œ ë…¸ì¶œ"ë˜ì–´ ë°ì´í„° ì¼ê´€ì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.

---

## 4. Partitionê³¼ Consumer ê´€ê³„

> **ê¸°ë³¸ ì›ì¹™**: í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì€ ê°™ì€ Consumer Group ë‚´ì—ì„œ ë‹¨ í•˜ë‚˜ì˜ Consumerë§Œ ì½ì„ ìˆ˜ ìˆë‹¤.

### ì¡°í•©ë³„ ì‹œë‚˜ë¦¬ì˜¤

| ì¡°í•© | ê²°ê³¼ | ì„¤ëª… |
|------|------|------|
| P = C | âœ… ì´ìƒì  | ëª¨ë“  Consumerê°€ ì¼í•˜ë©° ë¶€í•˜ ê· ë“± ë¶„ì‚° |
| P > C | âš ï¸ ì£¼ì˜ | Consumerë³„ ë¶€í•˜ ì¦ê°€, í•˜ë‚˜ ì£½ìœ¼ë©´ ë‚˜ë¨¸ì§€ê°€ ë” ë§ì´ ë‹´ë‹¹ |
| P < C | âŒ ë¹„íš¨ìœ¨ | ë†€ê³  ìˆëŠ” Consumer ë°œìƒ, ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ |

```
[Case: Partition 3ê°œ < Consumer 4ê°œ]

P0 â†’ Consumer A
P1 â†’ Consumer B
P2 â†’ Consumer C
     Consumer D (ë†€ê³  ìˆìŒ ğŸª‘)

â†’ Consumerë¥¼ ëŠ˜ë ¤ë„ ì²˜ë¦¬ëŸ‰ ì•ˆ ëŠ˜ì–´ë‚¨!
â†’ ì²˜ë¦¬ëŸ‰ ëŠ˜ë¦¬ë ¤ë©´ Partitionë¶€í„° ëŠ˜ë ¤ì•¼ í•¨
```

### ì—¬ëŸ¬ Consumer Group

```
Topic: orders (Partition 3ê°œ)

Consumer Group A: order-service
    P0 â†’ Consumer A1
    P1 â†’ Consumer A2
    P2 â†’ Consumer A3

Consumer Group B: notification-service
    P0 â†’ Consumer B1
    P1 â†’ Consumer B2
    P2 â†’ Consumer B3

â†’ ê°™ì€ ë©”ì‹œì§€ë¥¼ ë‘ ê·¸ë£¹ì´ ê°ê° ì†Œë¹„
â†’ ê° ê·¸ë£¹ì€ ë…ë¦½ì ì¸ offset ê´€ë¦¬
```

---

## 5. Consumer Rebalancing

### ë°œìƒ ì¡°ê±´

1. **Consumer ì¶”ê°€/ì œê±°**: ìƒˆ Consumer ì¡°ì¸, ì¥ì• , ì •ìƒ ì¢…ë£Œ
2. **Consumer ì²˜ë¦¬ ì§€ì—°**: `poll()` ê°„ê²©ì´ `max.poll.interval.ms` ì´ˆê³¼
3. **í† í”½/íŒŒí‹°ì…˜ ë³€ê²½**: êµ¬ë… ì¤‘ì¸ í† í”½ì— íŒŒí‹°ì…˜ ì¶”ê°€

### Rebalancing ê³¼ì • (Eager ë°©ì‹)

```
[ì´ˆê¸° ìƒíƒœ]
P0 â†’ Consumer A
P1 â†’ Consumer B
P2 â†’ Consumer C

[Consumer D ì¡°ì¸ ì‹œ]

Step 1: ëª¨ë“  Consumer íŒŒí‹°ì…˜ ë°˜ë‚© (Stop The World ğŸ’¥)
        â†’ ì´ ìˆœê°„ ì•„ë¬´ë„ ë©”ì‹œì§€ ëª» ì½ìŒ

Step 2: ë¦¬ë” ì„ ì¶œ & íŒŒí‹°ì…˜ ì¬í• ë‹¹

Step 3: ìƒˆ í• ë‹¹ìœ¼ë¡œ ì†Œë¹„ ì¬ê°œ
P0 â†’ Consumer A
P1 â†’ Consumer B
P2 â†’ Consumer D
     Consumer C (íŒŒí‹°ì…˜ 3ê°œ, Consumer 4ê°œë¼ ë†€ê²Œ ë¨)
```

### ë¬¸ì œì ê³¼ í•´ê²°ì±…

**ë¬¸ì œ**: Rebalancing ë™ì•ˆ ì „ì²´ Consumer Groupì´ ë©ˆì¶¤ â†’ Lag ê¸‰ì¦

**í•´ê²°ì±…**: Cooperative Rebalancing (Kafka 2.4+)

```properties
# ë³€ê²½ í•„ìš”í•œ íŒŒí‹°ì…˜ë§Œ ë°˜ë‚© â†’ ì ì§„ì  ì¬í• ë‹¹
partition.assignment.strategy=org.apache.kafka.clients.consumer.CooperativeStickyAssignor
```

---

## 6. ë¸Œë¡œì»¤ í´ëŸ¬ìŠ¤í„°ì™€ Replica

### ë¸Œë¡œì»¤ ì¦ì„¤ ì‹œ ì£¼ì˜ì 

**ë¸Œë¡œì»¤ë¥¼ ì¶”ê°€í•´ë„ ê¸°ì¡´ íŒŒí‹°ì…˜ì´ ìë™ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ë³µì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

```
[Broker 3 ì¶”ê°€ í›„]

         Broker 1          Broker 2          Broker 3
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ P0 (L)  â”‚       â”‚ P0 (F)  â”‚       â”‚         â”‚
        â”‚ P1 (F)  â”‚       â”‚ P1 (L)  â”‚       â”‚  ë¹„ì–´   â”‚
        â”‚ P2 (L)  â”‚       â”‚ P2 (F)  â”‚       â”‚  ìˆìŒ   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ ì•„ë¬´ ì¼ë„ ì•ˆ ì¼ì–´ë‚¨!
â†’ ìƒˆ í† í”½ ìƒì„± ì‹œì—ë§Œ ìë™ ë¶„ì‚°
â†’ ê¸°ì¡´ íŒŒí‹°ì…˜ì€ ìˆ˜ë™ ì¬í• ë‹¹ í•„ìš” (kafka-reassign-partitions.sh)
```

### "í™•ì¥ì— ìœ ë¦¬í•˜ë‹¤"ì˜ ì§„ì§œ ì˜ë¯¸

- **ë¬´ì¤‘ë‹¨ ì¶”ê°€**: ìƒˆ ë¸Œë¡œì»¤ ë¶™ì—¬ë„ ê¸°ì¡´ ë¸Œë¡œì»¤ ì•ˆ ê±´ë“œë¦¼
- **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: íŠ¸ë˜í”½ ë³´ë©´ì„œ ì²œì²œíˆ íŒŒí‹°ì…˜ ì˜®ê¸°ê¸° ê°€ëŠ¥
- **ìš©ëŸ‰/ì²˜ë¦¬ëŸ‰ í™•ë³´**: ìƒˆ í† í”½ì€ ìë™ ë¶„ì‚°, ê¸°ì¡´ ê²ƒë„ í•„ìš”ì‹œ ì´ë™

### Replica ì„¤ì •

**Replica ìˆ˜ëŠ” Kafka ì„¤ì •ìœ¼ë¡œ ì§€ì •í•˜ë©°, `Replica ìˆ˜ â‰¤ Broker ìˆ˜` ì œì•½ì´ ìˆìŠµë‹ˆë‹¤.**

```bash
# í† í”½ ìƒì„± ì‹œ ì§€ì •
kafka-topics.sh --create \
  --topic orders \
  --partitions 3 \
  --replication-factor 3 \
  --bootstrap-server localhost:9092
```

```
Broker 2ëŒ€ì¸ë° Replica 3ìœ¼ë¡œ ì„¤ì •í•˜ë©´?

Error: replication factor: 3 larger than available brokers: 2
â†’ ìƒì„± ìì²´ê°€ ì•ˆ ë¨

ì´ìœ : ê°™ì€ ë¸Œë¡œì»¤ì— ê°™ì€ íŒŒí‹°ì…˜ Replica 2ê°œ ìˆìœ¼ë©´
     ê·¸ ë¸Œë¡œì»¤ ì£½ì„ ë•Œ Replica 2ê°œ ë™ì‹œ ì†ì‹¤ â†’ ë³µì œ ì˜ë¯¸ ì—†ìŒ
```

### í•˜ë‚˜ì˜ ë¸Œë¡œì»¤ê°€ ì—¬ëŸ¬ Leaderë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‚˜?

**ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜¤íˆë ¤ ì¼ë°˜ì ì¸ ìƒí™©ì…ë‹ˆë‹¤.**

```
Broker 1: orders-P0 (Leader), payments-P1 (Leader)
Broker 2: orders-P1 (Leader), payments-P0 (Leader)
Broker 3: orders-P2 (Leader), payments-P2 (Leader)
```

**ì•ˆ ë˜ëŠ” ê²ƒ**: ê°™ì€ íŒŒí‹°ì…˜ì˜ Replicaê°€ ê°™ì€ ë¸Œë¡œì»¤ì— ì¤‘ë³µë˜ëŠ” ê²ƒ

---

## 7. ë©”ì‹œì§€ ì‹ ë¢°ì„± ë³´ì¥

### 7.1 Producer â†’ Broker ì‹ ë¢°ì„±

Producerê°€ Kafkaì— ë©”ì‹œì§€ë¥¼ ë°œí–‰í•  ë•Œë„ ìœ ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ í•µì‹¬ ì„¤ì •:

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|-----|------|
| `acks` | `all` | ëª¨ë“  ISR Replicaì— ë³µì œ ì™„ë£Œ í›„ ack ì‘ë‹µ |
| `retries` | `3` ì´ìƒ | ì¼ì‹œì  ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ |
| `enable.idempotence` | `true` | ì¤‘ë³µ ë°œí–‰ ë°©ì§€ (ì¬ì‹œë„ ì‹œì—ë„ exactly-once ë³´ì¥) |

```java
@Bean
public ProducerFactory<String, Object> producerFactory() {
    Map<String, Object> config = new HashMap<>();
    config.put(ProducerConfig.ACKS_CONFIG, "all");
    config.put(ProducerConfig.RETRIES_CONFIG, 3);
    config.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true);
    return new DefaultKafkaProducerFactory<>(config);
}
```

### 7.2 Consumer ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **At-Least-Once** ì „ë‹¬ì„ ë³´ì¥í•©ë‹ˆë‹¤. ì¦‰, ê°™ì€ ë©”ì‹œì§€ê°€ ë‘ ë²ˆ ì´ìƒ ì „ë‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì¤‘ë³µ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤**:
```
1. Consumerê°€ ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ
2. offset commit ì „ì— Consumer ì£½ìŒ
3. ì¬ì‹œì‘ í›„ ê°™ì€ ë©”ì‹œì§€ ë‹¤ì‹œ consume
```

**í•´ê²°ì±…: Idempotent Consumer**

Consumer ë¡œì§ì„ ë©±ë“±(idempotent)í•˜ê²Œ ì„¤ê³„í•˜ì—¬ ì¤‘ë³µ ì²˜ë¦¬í•´ë„ ê²°ê³¼ê°€ ê°™ë„ë¡ í•©ë‹ˆë‹¤.

```java
@KafkaListener(topics = "payment-completed")
public void handle(PaymentCompletedEvent event) {
    // ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸ì¸ì§€ í™•ì¸ (DBì— eventId ì €ì¥)
    if (eventRepository.existsById(event.getEventId())) {
        return;  // ì¤‘ë³µ ë¬´ì‹œ
    }

    processEvent(event);
    eventRepository.save(event.getEventId());  // ì²˜ë¦¬ ì™„ë£Œ ê¸°ë¡
}
```

---

## 8. Kafka ë„ì… ì‹œ ì¥ë‹¨ì 

### ì¥ì 

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ë©”ì‹œì§€ ì˜ì†ì„±** | ë””ìŠ¤í¬ ì €ì¥ìœ¼ë¡œ Consumer ì¥ì•  ì‹œì—ë„ ë©”ì‹œì§€ ìœ ì‹¤ ì—†ìŒ |
| **ì±…ì„ ë¶„ë¦¬** | ProducerëŠ” ë°œí–‰ë§Œ, Consumer ì¥ì•  ëŒ€ì‘ì€ Consumerê°€ ì•Œì•„ì„œ |
| **í™•ì¥ì„±** | Partition ì¶”ê°€ë¡œ ì²˜ë¦¬ëŸ‰ ì¦ê°€, Broker ì¶”ê°€ë¡œ ìš©ëŸ‰ í™•ë³´ |
| **ë‹¤ì¤‘ Consumer** | ê°™ì€ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ Consumer Groupì´ ê°ê° ì†Œë¹„ ê°€ëŠ¥ |
| **ì¬ì²˜ë¦¬ ìš©ì´** | offset ì¡°ì •ìœ¼ë¡œ ê³¼ê±° ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ê°€ëŠ¥ |

### ë‹¨ì  ë° ê³ ë ¤ì‚¬í•­

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ìš´ì˜ ë³µì¡ë„** | Broker, Zookeeper(ë˜ëŠ” KRaft) í´ëŸ¬ìŠ¤í„° ìš´ì˜ í•„ìš” |
| **Partition ì„¤ê³„** | ì²˜ìŒì— ì˜ëª» ì„¤ê³„í•˜ë©´ ë‚˜ì¤‘ì— ë³€ê²½ ì–´ë ¤ì›€ (ì¤„ì´ê¸° ë¶ˆê°€) |
| **Rebalancing** | Consumer ë³€ê²½ ì‹œ ì¼ì‹œì  ì²˜ë¦¬ ì¤‘ë‹¨ ë°œìƒ ê°€ëŠ¥ |
| **Producer â†’ Kafka êµ¬ê°„** | ì´ êµ¬ê°„ì€ ì—¬ì „íˆ Producerê°€ ì±…ì„ì ¸ì•¼ í•¨ (acks ì„¤ì • ë“±) |

### Zookeeper vs KRaft

Kafka 3.xë¶€í„° Zookeeper ì—†ì´ ìš´ì˜ ê°€ëŠ¥í•œ **KRaft ëª¨ë“œ**ê°€ ë„ì…ë˜ì—ˆìŠµë‹ˆë‹¤.

| êµ¬ë¶„ | Zookeeper ëª¨ë“œ | KRaft ëª¨ë“œ |
|------|---------------|-----------|
| ì˜ì¡´ì„± | Zookeeper í´ëŸ¬ìŠ¤í„° ë³„ë„ ìš´ì˜ | Kafka ë‹¨ë… ìš´ì˜ |
| ë©”íƒ€ë°ì´í„° | Zookeeperì— ì €ì¥ | Kafka ë‚´ë¶€ í† í”½ì— ì €ì¥ |
| í™•ì¥ì„± | Zookeeperê°€ ë³‘ëª© ê°€ëŠ¥ | ë” ë‚˜ì€ í™•ì¥ì„± |
| ìƒíƒœ | ë ˆê±°ì‹œ (Kafka 4.0ì—ì„œ ì œê±° ì˜ˆì •) | ê¶Œì¥ ë°©ì‹ |

---

## 9. ì‹¤ë¬´ ê°€ì´ë“œ

### ê¶Œì¥ ì„¤ì •

| ìƒí™© | ê¶Œì¥ |
|------|------|
| ì²˜ë¦¬ëŸ‰ ë¶€ì¡± | Partition ë¨¼ì € ëŠ˜ë¦¬ê³ , Consumer ì¦ì„¤ |
| Consumer ìì£¼ ì£½ìŒ | Partition > Consumerë¡œ ì—¬ìœ  ë‘ê¸° |
| ë©”ì‹œì§€ ìˆœì„œ ì¤‘ìš” | Partition 1ê°œ (ë‹¨, ì²˜ë¦¬ëŸ‰ í¬ê¸°) |
| ê°™ì€ Key ìˆœì„œ ë³´ì¥ | Key ê¸°ë°˜ íŒŒí‹°ì…”ë‹ í™œìš© |
| ì¦ì€ Rebalancing | `session.timeout.ms`, `max.poll.interval.ms` íŠœë‹ |
| ë°°í¬ ì‹œ ëŒ€ë€ | Rolling ë°°í¬ + Cooperative ì „ëµ |

### í•µì‹¬ ì„¤ì •ê°’

```properties
# Replica ê´€ë ¨
default.replication.factor=3
min.insync.replicas=2

# Consumer ê´€ë ¨
session.timeout.ms=45000
heartbeat.interval.ms=15000
max.poll.interval.ms=300000
max.poll.records=500

# Producer ê´€ë ¨
acks=all
retries=3
```

---

## 10. ê²°ë¡ 

### í˜„ì¬ ë¬¸ì œ â†’ Kafkaë¡œ í•´ê²°

| í˜„ì¬ | Kafka ë„ì… í›„ |
|------|--------------|
| ë©”ì‹œì§€ ìœ ì‹¤ ìœ„í—˜ | ë””ìŠ¤í¬ ì˜ì†í™”ë¡œ ì•ˆì „ ë³´ì¥ |
| ì¬ì‹œë„ ë¡œì§ ì§ì ‘ êµ¬í˜„ | offset ê¸°ë°˜ ìë™ ì¬ì²˜ë¦¬ |
| ì™¸ë¶€ ì‹œìŠ¤í…œ ì¥ì•  = ìš°ë¦¬ ì±…ì„ | ë°œí–‰ë§Œ í•˜ë©´ ì±…ì„ ë |
| ë‹¨ì¼ Consumer | ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ì†Œë¹„ |

### ë„ì… ì‹œ ì˜ˆìƒ êµ¬ì¡°

```
ì£¼ë¬¸ ì„œë¹„ìŠ¤
    â†“
kafkaProducer.publish(ê²°ì œ_ì™„ë£Œ_ì´ë²¤íŠ¸)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kafka Cluster                      â”‚
â”‚  Topic: payment-completed           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                    â†“
Consumer Group A     Consumer Group B
(ë°ì´í„° ìˆ˜ì§‘ í”Œë«í¼)   (ì•Œë¦¼ ì„œë¹„ìŠ¤)
```

**ì£¼ë¬¸ ì„œë¹„ìŠ¤ì—ì„œ ì´í›„ì— ì¼ì–´ë‚˜ëŠ” ë¶€ê°€ ë¡œì§ì— ëŒ€í•œ ê´€ì‹¬ì‚¬ê°€ ì™„ì „íˆ ì œê±°ë©ë‹ˆë‹¤.**

---

## 11. ì¶”ê°€ í•™ìŠµì´ í•„ìš”í•œ ì£¼ì œ

- `acks=all` ì„¤ì •ê³¼ ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€ ì „ëµ
- Transactional Outbox íŒ¨í„´ (DB íŠ¸ëœì­ì…˜ê³¼ Kafka ë°œí–‰ì˜ ì›ìì„± ë³´ì¥)
- ISR(In-Sync Replicas)ì—ì„œ Followerê°€ ë’¤ì²˜ì§€ë©´ ì–´ë–»ê²Œ ë˜ëŠ”ì§€
- Partition ê°œìˆ˜ë¥¼ ë‚˜ì¤‘ì— ëŠ˜ë¦¬ë©´ ê¸°ì¡´ Key ê¸°ë°˜ íŒŒí‹°ì…”ë‹ì— ì–´ë–¤ ë¬¸ì œê°€ ìƒê¸°ëŠ”ì§€
- `auto.offset.reset` ì„¤ì •ì´ ì–¸ì œ ì‘ë™í•˜ëŠ”ì§€

---

*ì‘ì„±ì¼: 2025ë…„*
*ì‘ì„±ì: Backend Team*