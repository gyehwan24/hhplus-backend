# Kafka 클러스터 구성 가이드

## 1. 개요

프로덕션 환경에서 Kafka 클러스터를 구성하는 방법을 학습하는 문서입니다.

---

## 2. 클러스터 구성 방식 비교

| 방식 | 복잡도 | 비용 | 운영 부담 | 적합한 상황 |
|------|--------|------|----------|------------|
| Docker Compose | 낮음 | 무료 | 없음 | 개발/학습 |
| VM 직접 구성 | 높음 | 중간 | 높음 | 커스터마이징 필요 시 |
| AWS MSK | 중간 | 높음 | 낮음 | 프로덕션 운영 |
| Confluent Cloud | 낮음 | 높음 | 매우 낮음 | 빠른 구축 필요 시 |

---

## 3. Docker Compose (로컬 개발용)

### 구성도
```
┌─────────────────────────────────────────────────────────┐
│                    Docker Network                       │
│                                                         │
│  ┌─────────────┐                                        │
│  │  Zookeeper  │  - 클러스터 메타데이터 관리                │
│  └──────┬──────┘  - 브로커 상태 모니터링                   │
│         │                                               │
│    ┌────┴────┬──────────┐                               │
│    ▼         ▼          ▼                               │
│ ┌──────┐ ┌──────┐ ┌──────┐                              │
│ │Broker│ │Broker│ │Broker│                              │
│ │  1   │ │  2   │ │  3   │                              │
│ └──────┘ └──────┘ └──────┘                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 특징
- 단일 명령어로 클러스터 구성 (`docker compose up`)
- 개발/테스트 환경에 적합
- 프로덕션 사용 불가 (단일 머신 장애 시 전체 중단)

### 한계
| 항목 | 로컬 환경 | 프로덕션 요구사항 |
|------|----------|-----------------|
| 가용성 | 단일 머신 의존 | 다중 AZ 분산 |
| 데이터 | 컨테이너 삭제 시 손실 | 영구 스토리지 |
| 보안 | 인증 없음 | TLS, SASL 인증 |
| 모니터링 | 수동 로그 확인 | 메트릭/알람 시스템 |

### 왜 프로덕션에 부적합한가?

**Docker Compose는 단일 머신 전용 도구**입니다.

```
┌─────────────────────────────────────────┐
│           Single Host Machine            │
│                                          │
│  ┌────────┐ ┌────────┐ ┌────────┐       │
│  │Broker 1│ │Broker 2│ │Broker 3│       │
│  └────────┘ └────────┘ └────────┘       │
│                                          │
│  ⚠️ 이 머신이 죽으면 → 전체 클러스터 중단   │
└─────────────────────────────────────────┘
```

3개 브로커를 띄워도 **같은 서버**에 있으면:
- 서버 장애 → 전체 중단
- 네트워크 장애 → 전체 중단
- 디스크 장애 → 데이터 손실

### 여러 서버에서 Docker Compose를 각각 실행하면?

```
❌ 잘못된 접근

┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Server A  │  │   Server B  │  │   Server C  │
│  compose up │  │  compose up │  │  compose up │
│   Broker 1  │  │   Broker 2  │  │   Broker 3  │
└─────────────┘  └─────────────┘  └─────────────┘

문제점:
- 각 서버에서 개별적으로 실행 (오케스트레이션 없음)
- 장애 감지/복구 수동
- 결국 "VM 직접 구성"과 동일 (컨테이너로 감쌌을 뿐)
```

### 다중 서버에서 컨테이너를 사용하려면?

| 도구 | 다중 서버 | 자동 복구 | 프로덕션 적합 |
|------|----------|----------|--------------|
| Docker Compose | ❌ | ❌ | ❌ |
| Docker Swarm | ✅ | ✅ | ⚠️ 소규모 |
| Kubernetes | ✅ | ✅ | ✅ |

```
✅ 올바른 접근 (Kubernetes)

┌────────────────────────────────────────────────┐
│              Kubernetes Control Plane           │
│  "Broker 3개를 서로 다른 노드에 배포해줘"         │
│  "장애 나면 자동으로 재시작해줘"                  │
└─────────────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │ Node A  │   │ Node B  │   │ Node C  │
   │Broker 1 │   │Broker 2 │   │Broker 3 │
   └─────────┘   └─────────┘   └─────────┘

- 중앙에서 클러스터 전체 관리
- 노드 장애 시 자동 재배치
- Strimzi (Kafka Operator) 활용
```

---

## 4. VM 직접 구성

### 구성도
```
┌─────────────────────────────────────────────────────────────────┐
│                         VPC                                      │
│                                                                  │
│  ┌─────────────────────┐  ┌─────────────────────┐               │
│  │      AZ-A           │  │      AZ-B           │               │
│  │  ┌───────────────┐  │  │  ┌───────────────┐  │               │
│  │  │  Zookeeper 1  │  │  │  │  Zookeeper 2  │  │               │
│  │  │   Broker 1    │  │  │  │   Broker 2    │  │               │
│  │  └───────────────┘  │  │  └───────────────┘  │               │
│  └─────────────────────┘  └─────────────────────┘               │
│                                                                  │
│  ┌─────────────────────┐                                        │
│  │      AZ-C           │   * Zookeeper: 3대 (과반수 Quorum)      │
│  │  ┌───────────────┐  │   * Broker: 3대 (Replication Factor 2) │
│  │  │  Zookeeper 3  │  │                                        │
│  │  │   Broker 3    │  │                                        │
│  │  └───────────────┘  │                                        │
│  └─────────────────────┘                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 핵심 개념

**Zookeeper Quorum**
- 최소 3대 구성 (과반수 2대 동의 필요)
- 1대 장애 시에도 클러스터 운영 가능
- 리더 선출, 메타데이터 관리

**멀티 AZ 배포**
- 각 가용 영역(AZ)에 브로커 분산
- 데이터센터 장애에도 서비스 유지
- 네트워크 지연 최소화

### 장단점
| 장점 | 단점 |
|------|------|
| 완전한 제어권 | 높은 운영 부담 |
| 커스터마이징 자유도 | 장애 대응 직접 수행 |
| 비용 최적화 가능 | 보안 패치 직접 관리 |

---

## 5. AWS MSK (Managed Streaming for Kafka)

### 구성도
```
┌─────────────────────────────────────────────────────────────────┐
│                         AWS Region                               │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Amazon MSK Cluster                    │    │
│  │                                                          │    │
│  │   ┌─────────┐    ┌─────────┐    ┌─────────┐            │    │
│  │   │ Broker  │    │ Broker  │    │ Broker  │            │    │
│  │   │  (AZ-A) │    │  (AZ-B) │    │  (AZ-C) │            │    │
│  │   └─────────┘    └─────────┘    └─────────┘            │    │
│  │                                                          │    │
│  │   AWS가 관리하는 영역:                                     │    │
│  │   - 자동 장애 복구                                        │    │
│  │   - 자동 보안 패치                                        │    │
│  │   - CloudWatch 메트릭 통합                                │    │
│  │   - 암호화 (전송 중 / 저장 시)                             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 핵심 개념

**완전 관리형 서비스**
- Zookeeper 관리 불필요 (AWS가 내부적으로 관리)
- 브로커 장애 시 자동 복구
- 보안 패치 자동 적용

**AWS 서비스 통합**
- IAM 기반 인증/인가
- CloudWatch 메트릭 및 로그
- VPC 내부 통신 (보안)

### 비용 구조
```
브로커 인스턴스: 시간당 과금
스토리지: GB-월당 과금
데이터 전송: AZ 간 전송 비용

예상 월 비용 (3 브로커 기준): ~$450-500/month
```

### 장단점
| 장점 | 단점 |
|------|------|
| 운영 부담 최소화 | 높은 비용 |
| 자동 장애 복구 | 커스터마이징 제한 |
| AWS 서비스 통합 | VPC 내부에서만 접근 |
| 고가용성 보장 | 브로커 수 변경 제한 |

---

## 6. 프로덕션 운영 시 고려사항

### 보안
- **TLS 암호화**: 클라이언트-브로커, 브로커 간 통신 암호화
- **SASL 인증**: 클라이언트 인증 (SCRAM, IAM 등)
- **ACL**: 토픽별 접근 제어

### 모니터링
- **핵심 메트릭**
  - `UnderReplicatedPartitions`: 복제 지연 파티션 수
  - `OfflinePartitionsCount`: 오프라인 파티션 수
  - `Consumer Lag`: 메시지 처리 지연

### 가용성
- **Replication Factor ≥ 2**: 데이터 복제로 안정성 확보
- **min.insync.replicas**: 최소 동기화 복제본 수 설정
- **멀티 AZ 배포**: 가용 영역 장애 대비

---

## 7. 환경별 권장 구성

| 환경 | 권장 방식 | 이유 |
|------|----------|------|
| 로컬 개발 | Docker Compose | 빠른 설정, 비용 없음 |
| 테스트 | MSK (최소 구성) | 프로덕션과 유사한 환경 |
| 프로덕션 | MSK | 운영 부담 최소화, 안정성 |
| 대규모/특수 요구 | VM 직접 구성 | 비용 최적화, 커스터마이징 |

---

## 8. 핵심 요약

```
1. 클러스터 구성
   - 최소 3 브로커 권장 (Quorum 유지)
   - 멀티 AZ 배포로 가용성 확보

2. 데이터 안정성
   - Replication Factor ≥ 2
   - min.insync.replicas 설정

3. 운영 방식 선택
   - 학습/개발: Docker Compose
   - 프로덕션: AWS MSK (관리형 서비스 권장)

4. 보안
   - TLS + SASL 인증은 프로덕션 필수
```
