# 콘서트 예약 시스템 - 최종 발표 자료

---

## 1. 시스템 개요

### 1.1 서비스 소개

**콘서트 예약 시스템**은 대규모 티켓팅 트래픽을 안정적으로 처리하기 위한 예약 플랫폼입니다.

**핵심 기능:**
- 대기열 기반 트래픽 제어
- 실시간 좌석 조회 및 예약
- 콘서트 랭킹 시스템

### 1.2 기술 스택

| 분류 | 기술 |
|------|------|
| Backend | Java 17, Spring Boot 3.4.1 |
| Database | MySQL 8.0, Redis 7 |
| ORM | JPA/Hibernate |
| 캐시 | Redis (Spring Cache) |
| 분산락 | Redisson |
| 메시징 | Kafka (이벤트 발행) |
| 테스트 | JUnit 5, Testcontainers |

### 1.3 아키텍처

```
┌────────────────────────────────────────────────────────────────┐
│                        Client Layer                             │
└─────────────────────────────┬──────────────────────────────────┘
                              │
┌─────────────────────────────▼──────────────────────────────────┐
│                     API Gateway / LB                            │
└─────────────────────────────┬──────────────────────────────────┘
                              │
┌─────────────────────────────▼──────────────────────────────────┐
│                   Spring Boot Application                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │   Concert   │ │    Token    │ │ Reservation │ │  Payment  │ │
│  │   Domain    │ │   Domain    │ │   Domain    │ │  Domain   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
└───────┬─────────────────┬────────────────┬─────────────────────┘
        │                 │                │
┌───────▼───────┐ ┌───────▼───────┐ ┌──────▼──────┐
│    MySQL      │ │    Redis      │ │    Kafka    │
│  (데이터 저장) │ │ (대기열/캐시) │ │ (이벤트 발행) │
└───────────────┘ └───────────────┘ └─────────────┘
```

### 1.4 도메인 구조

```
├── concert/          # 콘서트, 스케줄, 좌석 (Layered)
├── reservation/      # 예약 (Clean Architecture)
├── payment/          # 결제 (Clean Architecture)
├── token/            # 대기열 토큰 (Redis)
└── user/             # 사용자 잔액 (Layered)
```

---

## 2. 주요 API 및 기능

### 2.1 API 목록

| API | Method | Endpoint | 설명 | 캐시 |
|-----|--------|----------|------|------|
| 토큰 발급 | POST | `/api/queue/token` | 대기열 진입 | - |
| 상태 조회 | GET | `/api/queue/status` | 대기열 상태 | - |
| 콘서트 목록 | GET | `/api/concerts` | 전체 목록 | 5분 |
| 콘서트 상세 | GET | `/api/concerts/{id}` | 상세 정보 | 10분 |
| 스케줄 조회 | GET | `/api/concerts/{id}/schedules` | 예약 가능 일정 | 3분 |
| 좌석 조회 | GET | `/api/schedules/{id}/seats` | 예약 가능 좌석 | 10초 |
| 랭킹 조회 | GET | `/api/concerts/ranking` | 인기 순위 | - |

### 2.2 동시성 제어 전략

| 기능 | 전략 | 구현 |
|------|------|------|
| 좌석 예약 | Pessimistic Lock | `SELECT ... FOR UPDATE` |
| 잔액 차감 | Optimistic Lock | `@Version` |
| 토큰 활성화 | Distributed Lock | Redisson |
| 대기열 관리 | Redis Sorted Set | `ZADD`, `ZRANGE` |

---

## 3. 성능 테스트 결과

### 3.1 테스트 환경

| 항목 | 설정 |
|------|------|
| 도구 | JMeter 5.6.3 |
| 데이터 | 콘서트 10개, 좌석 5,000개 |
| 인프라 | Docker (MySQL, Redis) |

### 3.2 테스트 결과 요약

#### 기본 부하 (350 동시 사용자)

| 지표 | 값 | 평가 |
|------|-----|------|
| 총 요청 | 814,975 | - |
| **TPS** | **4,523** | 우수 |
| **평균 응답** | **17ms** | 우수 |
| **에러율** | **0.00%** | 우수 |

#### 고부하 (730 동시 사용자) - 개선 후

| 지표 | 개선 전 | 개선 후 | 평가 |
|------|---------|---------|------|
| 총 요청 | 807,052 | 689,030 | - |
| TPS | 4,479 | 4,500+ | 우수 |
| 평균 응답 | 17ms | ~20ms | 우수 |
| **에러율** | **3.30%** | **0.01%** | **개선 완료** |

### 3.3 API별 성능

```
┌────────────────────────────────────────────────────────────────┐
│                    Response Time Distribution                   │
├────────────────────────────────────────────────────────────────┤
│  콘서트 목록  │████████████████████████████████████│  ~5ms     │
│  콘서트 상세  │████████████████████████████████████│  ~5ms     │
│  스케줄 조회  │██████████████████████████████████████│ ~10ms    │
│  좌석 조회    │████████████████████████████████████████│ ~15ms  │
│  상태 조회    │████████████████████████████████████│  ~5ms     │
│  토큰 발급    │████████████████████████████████████████████│~20ms│
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 시스템 수용량

### 4.1 기능별 최대 처리량

| 기능 | 최대 TPS | 제한 요인 |
|------|---------|----------|
| 콘서트 조회 | 5,000+ | 캐시 의존 |
| 좌석 조회 | 3,000+ | 캐시 TTL 10초 |
| 토큰 발급 | **~100** | **Redis 동시성** |
| 상태 조회 | 5,000+ | Redis 단순 조회 |

### 4.2 권장 운영 스펙

| 환경 | 동시 사용자 | 앱 서버 | MySQL | Redis |
|------|-----------|---------|-------|-------|
| 개발 | ~50 | 1 core / 1GB | 1 core / 2GB | 0.5 core / 512MB |
| 스테이징 | ~200 | 2 cores / 2GB | 2 cores / 4GB | 1 core / 1GB |
| **운영** | **~500** | **4 cores / 4GB** | **4 cores / 8GB** | **2 cores / 2GB** |

### 4.3 스케일링 전략

```
현재: 단일 인스턴스 (동시 500명)
     │
     ▼ 부하 증가
Scale-Up: 리소스 증설 (동시 1,000명)
     │
     ▼ 부하 증가
Scale-Out: 인스턴스 추가 (동시 2,000명+)
     │
     ├── App: Load Balancer + 2+ 인스턴스
     ├── DB: Read Replica 추가
     └── Redis: Cluster 구성
```

---

## 5. 식별 및 해결된 취약점

### 5.1 병목 지점 (개선 완료)

| 순위 | 취약점 | 증상 | 해결 방법 | 상태 |
|------|--------|------|----------|------|
| 1 | **토큰 발급 API** | HTTP 500 (고부하 시) | Lua 스크립트 원자화 | **해결** |
| 2 | DB Connection Pool (3) | 잠재적 고갈 | HikariCP 20으로 증가 | **해결** |
| 3 | Redisson Pool (50) | 연결 부족 | 100으로 증가 | **해결** |

### 5.2 토큰 발급 API 개선 상세

```
문제: 730 동시 사용자에서 3.3% 에러 발생
원인: check-then-add 패턴에서 Race Condition 발생

적용된 개선:
1. Lua 스크립트로 원자적 처리 (ZSCORE → ZADD → ZRANK)
2. TokenExceptionHandler 추가 (중복 요청 → HTTP 409)
3. HikariCP/Redisson 풀 크기 증가

결과: 에러율 3.3% → 0.01%
```

### 5.3 적용된 개선 사항

```
┌─────────────────────────────────────────────────────────────┐
│                     적용 완료 사항                            │
├─────────────────────────────────────────────────────────────┤
│ [완료] HikariCP Pool 증가: 3 → 20                           │
│ [완료] Redisson Pool 증가: 50 → 100                         │
│ [완료] 대기열 추가 Lua 스크립트 원자화                        │
│ [완료] TokenExceptionHandler 추가 (HTTP 409)                │
├─────────────────────────────────────────────────────────────┤
│ [향후] 수평 확장 아키텍처 준비                               │
│ [향후] Redis Cluster 도입                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 장애 대응 체계

### 6.1 장애 등급

| 등급 | 정의 | 대응 시간 |
|------|------|----------|
| P1 | 전체 서비스 중단 | 15분 내 |
| P2 | 핵심 기능 장애 | 30분 내 |
| P3 | 부분 기능 저하 | 2시간 내 |

### 6.2 주요 장애 시나리오

| 장애 | 증상 | 즉시 대응 |
|------|------|----------|
| 앱 다운 | Health check 실패 | 컨테이너 재시작 |
| DB 연결 불가 | Connection refused | MySQL 재시작 |
| Redis 장애 | 대기열 중단 | Redis 재시작, Fallback |
| 고부하 | 응답 지연, 에러 증가 | Rate Limiting, 스케일 아웃 |

### 6.3 모니터링 알림

| 지표 | Warning | Critical |
|------|---------|----------|
| 응답 시간 P95 | > 500ms | > 1000ms |
| 에러율 | > 0.5% | > 1% |
| CPU 사용률 | > 70% | > 90% |
| DB Connection | > 70% | > 90% |

---

## 7. 결론

### 7.1 강점

- **우수한 읽기 성능**: 캐시 적용으로 평균 17ms 응답
- **안정적인 기본 부하 처리**: 350 동시 사용자, 0% 에러
- **효과적인 대기열**: Redis 기반 실시간 처리
- **고부하 안정성 확보**: 730 동시 사용자, 0.01% 에러 (개선 완료)

### 7.2 적용 완료

- **토큰 발급 API 안정화**: Lua 스크립트 원자화로 해결
- **DB Connection Pool 증가**: 3 → 20 적용 완료
- **Redisson Pool 증가**: 50 → 100 적용 완료

### 7.3 검증된 결과

| 항목 | 개선 전 | 개선 후 |
|------|---------|---------|
| 동시 사용자 | 500 이하 권장 | **730명 검증 완료** |
| HikariCP | 3 | **20 적용** |
| Redisson | 50 | **100 적용** |
| 에러율 (고부하) | 3.3% | **0.01%** |

---

## 8. Q&A

### 자주 묻는 질문

**Q1. 왜 토큰 발급 API에서만 에러가 발생했나요?**
> check-then-add 패턴에서 Race Condition이 발생했습니다.
> Lua 스크립트로 원자화하여 해결했습니다.

**Q2. 검증된 최대 동시 사용자는?**
> 개선 후 730명에서 에러율 0.01%로 안정적입니다.
> 스케일 아웃 시 2,000명+ 가능합니다.

**Q3. 어떤 개선이 가장 효과적이었나요?**
> Lua 스크립트 원자화가 핵심이었습니다. Race Condition 해결 후 에러율이 3.3% → 0.01%로 개선되었습니다.

---

## 부록

### A. 테스트 결과 파일

```
server-java/docs/10th/
├── load-test-plan.md           # 테스트 계획서
├── load-test-result.md         # 결과 보고서
├── deployment-spec.md          # 배포 스펙
├── incident-response-manual.md # 장애 대응 매뉴얼
└── jmeter/
    ├── concert-full-load-test.jmx
    └── results/
        ├── report_20251227_093200/   # 기본 부하 리포트
        └── report_high_20251227_*/   # 고부하 리포트
```

### B. 핵심 명령어

```bash
# 부하 테스트 실행
./docs/10th/jmeter/run-load-test.sh

# 시스템 상태 확인
curl http://localhost:8080/actuator/health

# 모니터링
docker stats
```

---
